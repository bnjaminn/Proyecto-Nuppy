{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración de Usuarios - NUAM</title>
    
    <link rel="stylesheet" href="{% static 'prueba/css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'prueba/css/administrar.css' %}">
    <link rel="stylesheet" href="{% static 'prueba/css/modal.css' %}">
    
</head>
<body>

    <header class="header">
        <div class="header-left">
            <h2>Administración de Usuarios</h2>
        </div>
        <div class="header-right">
            <div class="user-info">
                Admin: <strong>{{ user_nombre }}</strong>
                <a href="{% url 'home' %}" class="btn btn-secondary" style="margin-left: 1rem;">(Volver al Dashboard)</a> 
                <a href="{% url 'logout' %}" style="margin-left: 0.5rem;">(Cerrar Sesión)</a>
            </div>
        </div>
    </header>

    <main class="admin-container">
        
        <div class="user-management-layout">
            
            <div class="user-actions">
                <button class="btn" id="btn-abrir-crear-usuario">Crear Usuario</button>
                <button class="btn btn-secondary" id="btn-modificar-usuario" disabled>Modificar Usuario</button> 
                <button class="btn btn-danger" id="btn-eliminar-usuario" disabled>Eliminar Usuario</button> 
            </div>

            <div class="user-grid">
                
                {% for usuario in lista_usuarios %}
                    <div class="user-card" data-user-id="{{ usuario.id }}"> 
                        <h4>{{ usuario.nombre }}</h4>
                        <p>{{ usuario.correo }}</p>
                        <p>Rol: 
                            {% if usuario.rol %}
                                <span class="role">Administrador</span>
                            {% else %}
                                Usuario Estándar
                            {% endif %}
                        </p>
                    </div>
                {% empty %}
                    <p>No hay usuarios registrados.</p>
                {% endfor %}

            </div>
        </div>
    </main> {% include 'prueba/modal_crear_usuario.html' %}
            {% include 'prueba/modal_modificar_usuario.html' %}




            
    <script defer> //Espera a que TODO el HTML este cargado y listo antes de ejecutar el código
document.addEventListener('DOMContentLoaded', function() { 
    console.log("DOM Cargado. Iniciando TODOS los scripts..."); 

    //SECCION 1: Selección/Deseleccion de Usuarios
    const userCards = document.querySelectorAll('.user-card'); //Todas las tarjetas de usuario
    const btnModificar = document.querySelector('#btn-modificar-usuario'); //Boton Modificar
    const btnEliminar = document.querySelector('#btn-eliminar-usuario');  //Boton eliminar  
    let selectedUserIds = []; // Array para almacenar los ID de los usuarios seleccionados

    function actualizarBotonesAccion() { //Funcion que se llama cada vez que cambia la seleccion
        const selectedCards = document.querySelectorAll('.user-card.selected'); //Cuenta cuantas tarjetas tienen la clase selected
        const count = selectedCards.length;
        
        if (btnModificar) btnModificar.disabled = (count !== 1); //Habilita/deshabilita el botón Modificar: solo si hay 1 seleccionado
        if (btnEliminar) btnEliminar.disabled = (count === 0); 

        selectedUserIds = Array.from(selectedCards).map(card => card.dataset.userId); //Actualiza la lista de ID seleccionados
        console.log(count + " usuario(s) seleccionado(s):", selectedUserIds);
    }

    userCards.forEach(card => { //Añade un detector de clics a cada tarjeta de usuario
        card.addEventListener('click', () => {
            card.classList.toggle('selected'); //Cuando se hace clic alterna la clase selected (la añade si no está la quita si esta)
            actualizarBotonesAccion(); //Llama a la función para actualizar el estado de los botones Modificar/Eliminar
        });
    });

    actualizarBotonesAccion();  //Llama a la función una vez al cargar la página para establecer el estado inicial (botones deshabilitados)
    console.log("Lógica de selección de usuarios inicializada.");

    //SECCION 2: Modal Crear Usuario
    //Busca los elementos HTML del modal Crear por sus ID
    const modalCrearOverlay = document.getElementById('crear-usuario-modal-overlay');
    const btnAbrirCrear = document.getElementById('btn-abrir-crear-usuario'); 
    const btnCerrarCrear = document.getElementById('btn-cerrar-crear-usuario');
    const btnCerrarCrearX = document.getElementById('btn-cerrar-crear-usuario-x');
    const formCrearUsuario = document.getElementById('form-crear-usuario');

    function abrirModalCrear() { //Funcion para mostrar el modal crear
        if (!modalCrearOverlay) return; //si no se encontró el modal no hace nada
        if (formCrearUsuario) formCrearUsuario.reset(); //Si se encontró el formulario lo resetea (limpia campos)
        modalCrearOverlay.style.display = 'flex'; //Cambia el estilo CSS para mostrar el modal
    }
    function cerrarModalCrear() { //Funcion para ocultar el modal Crear
        if (!modalCrearOverlay) return;
        modalCrearOverlay.style.display = 'none'; //Cambia el estilo CSS para ocultarlo
    }

    if (btnAbrirCrear) btnAbrirCrear.addEventListener('click', abrirModalCrear); // aqui asignamos la función abrirModalCrear al evento del botón principal "Crear Usuario"
    if (btnCerrarCrear) btnCerrarCrear.addEventListener('click', cerrarModalCrear);
    if (btnCerrarCrearX) btnCerrarCrearX.addEventListener('click', cerrarModalCrear);
    if (modalCrearOverlay) {
        modalCrearOverlay.addEventListener('click', (e) => { 
            if (e.target === modalCrearOverlay) cerrarModalCrear(); 
        });
    }
    
    if (formCrearUsuario) { //Logica para cuando se envia el formulario dentro del modal Crear
        formCrearUsuario.addEventListener('submit', function(event) {
            event.preventDefault(); //Evita que la pagina se recargue
            const formData = new FormData(formCrearUsuario); //Recolecta todos los datos del formulario
            const url = formCrearUsuario.action; //Obtiene la URL de la vista Django
            if (!formData.has('rol')) { formData.append('rol', 'false'); } else { formData.set('rol', 'true'); } //Manejo especial para el checkbox rol si no esta marcado, no se envía por defecto

            // Envia los datos al servidor usando Fetch (AJAX) con metodo POST
            fetch(url, { 
                method: 'POST', 
                body: formData, //Los datos del formulario
                headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }  //Token de seguridad de Django
            })
            .then(response => {  //Procesa la respuesta inicial del servidor junto con los errores
                if (!response.ok) return response.text().then(text => { throw new Error(`Error ${response.status}: ${text}`) });
                return response.json();  // Si todo OK intenta leer el cuerpo como JSON
            })
            .then(data => {  //Procesa los datos JSON si todo salio bien
                if (data.success) {
                    alert('Usuario creado exitosamente!');
                    cerrarModalCrear(); // # Cierra el modal si todo sale bien
                    window.location.reload(); 
                } else { // # Si indica error Muestra los errores
                    alert('Error al crear usuario: ' + (data.error || 'Intenta de nuevo.'));
                }
            })
            .catch(error => { // # Atrapa errores de red
                alert('Error al crear usuario:\n' + error.message);
            });
        });
    }
    console.log("Lógica del modal Crear Usuario inicializada.");

    //SECCION 3: Eliminar Usuario
    if (btnEliminar) { //Reutiliza la variable btnEliminar de la SecciOn 1
        btnEliminar.addEventListener('click', function() { //AsignaMOS la logica al evento click del botón Eliminar Usuario
            const selectedCards = document.querySelectorAll('.user-card.selected'); //Obtiene los ID de todas las tarjetas seleccionadas
            const userIdsToDelete = Array.from(selectedCards).map(card => card.dataset.userId);

            if (userIdsToDelete.length === 0) { //Verifica si hay usuarios seleccionados
                alert("Selecciona al menos un usuario para eliminar.");
                return; 
            }
            if (!confirm(`¿Eliminar ${userIdsToDelete.length} usuario(s)?`)) return; //Pide confirmacion

            const url = "{% url 'eliminar_usuarios' %}"; //URL de la vista Django
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value; 

            fetch(url, { //Envía la lista de ID al servidor como JSON usando Fetch y método POST
                method: 'POST', 
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, //Indica que enviamos JSON
                body: JSON.stringify({ user_ids: userIdsToDelete }) //Convierte la lista a texto JSON
            })
            .then(response => {
                if (!response.ok) return response.text().then(text => { throw new Error(`Error ${response.status}: ${text}`) }); //Manejo de error
                return response.json();
            })
            .then(data => { //Procesa el JSON 
                if (data.success) {
                    alert(`${data.deleted_count || userIdsToDelete.length} usuario(s) eliminado(s).`); //Muestra mensaje de éxito
                    window.location.reload(); //Recarga la página
                } else {
                    alert('Error al eliminar: ' + (data.error || 'Intenta de nuevo.'));
                }
            })
            .catch(error => {
                alert('Error de conexión al eliminar:\n' + error.message);
            });
        });
    }

    //SECCION 4: Modal Modificar Usuario
    //Busca los elementos HTML del modal Modificar
    const modalModificarOverlay = document.getElementById('modificar-usuario-modal-overlay');
    const btnCerrarModificar = document.getElementById('btn-cerrar-modificar-usuario');
    const btnCerrarModificarX = document.getElementById('btn-cerrar-modificar-usuario-x');
    const formModificarUsuario = document.getElementById('form-modificar-usuario');

    function abrirModalModificar() { //Funciones para abrir/cerrar el modal Modificar
        if (!modalModificarOverlay) return;
        const selectedCard = document.querySelector('.user-card.selected');
        if (!selectedCard) {
            alert("Selecciona un usuario para modificar.");
            return;
        }

        const userId = selectedCard.dataset.userId; //Obtiene el ID del usuario
        const nombre = selectedCard.querySelector('h4').textContent;
        const correo = selectedCard.querySelector('p').textContent;
        const rolText = selectedCard.querySelector('.role') ? true : false;

        document.getElementById('modificar-user-id').value = userId;
        document.getElementById('modificar-nombre').value = nombre;
        document.getElementById('modificar-correo').value = correo;
        document.getElementById('modificar-rol').checked = rolText;

        modalModificarOverlay.style.display = 'flex';
    }

    function cerrarModalModificar() { //Funcion para cerrar el modal Modificar
        if (!modalModificarOverlay) return;
        modalModificarOverlay.style.display = 'none';
    }

    if (btnModificar) btnModificar.addEventListener('click', abrirModalModificar); // Asigna la funcion abrirModalModificar al evento click del botón principal "Modificar Usuario"
    //Asigna las funciones de cierre a los botones 'Cancelar', 'X' y fondo del modal Modificar
    if (btnCerrarModificar) btnCerrarModificar.addEventListener('click', cerrarModalModificar);
    if (btnCerrarModificarX) btnCerrarModificarX.addEventListener('click', cerrarModalModificar);
    if (modalModificarOverlay) {
        modalModificarOverlay.addEventListener('click', (e) => {
            if (e.target === modalModificarOverlay) cerrarModalModificar();
        });
    }

    if (formModificarUsuario) { //Logica para cuando se envía el formulario dentro del modal Modificar
        formModificarUsuario.addEventListener('submit', function(event) {
            event.preventDefault(); // # Evita recarga
            console.log("[Modificar] Enviando formulario...");

            const formData = new FormData(formModificarUsuario); // # Recolecta datos
            if (!formData.has('rol')) formData.append('rol', 'false');
            else formData.set('rol', 'true');

            const url = formModificarUsuario.action;
            const csrf = formData.get('csrfmiddlewaretoken');

            fetch(url, { //Envia los datos modificados
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrf }
            })
            .then(async response => {
                const text = await response.text();
                let json = null;
                try { json = JSON.parse(text); } catch(e) {}
                if (!response.ok) {
                    const msg = (json && (json.error || JSON.stringify(json))) || text || response.statusText;
                    throw new Error(`HTTP ${response.status}: ${msg}`);
                }
                return json || {}; //Devuelve JSON o {}
            })
            .then(data => { // # Procesa JSON
                if (data.success) {
                    alert('Usuario modificado exitosamente.');
                    cerrarModalModificar();
                    window.location.reload(); //Recarga página
                } else {
                    alert('No se pudo modificar: ' + (data.error || 'Error desconocido.'));
                }
            })
            .catch(error => {
                alert('Error al modificar usuario:\n' + error.message);
            });
        });
    }

    console.log("Script completo cargado y listeners asignados.");  
});
</script>


</body>
</html>